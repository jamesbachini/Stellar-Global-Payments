# Stellar Global Payments - Backend

Node.js + TypeScript + Express backend that acts as a hot wallet/relayer for submitting transactions to Stellar smart accounts.

## Quick Start

### 1. Prerequisites

- Node.js 18+ installed
- Contracts deployed (run `../deploy.sh` from repo root)
- Admin account with secret key

### 2. Install Dependencies

```bash
npm install
```

### 3. Configure Secrets

Create a `.env` file with **3 required secrets**:

```bash
# Copy example and edit
cp .env.example .env
```

Then edit `.env` and set:

```env
ADMIN_SECRET_KEY=SA...YOUR_SECRET_KEY_HERE
ADMIN_AUTH_TOKEN=your_random_secure_token_here
SOROSWAP_API_KEY=sk_live_or_test_key_from_soroswap
```

Generate a secure auth token:
```bash
openssl rand -hex 32
```

### 4. Run

```bash
# Development mode (auto-restart)
npm run dev

# Production build
npm run build
npm start
```

## 5. Recover funds

Setup a trustline, change the source account

```bash
stellar tx new change-trust \
--source james \
--line USDC:GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN \
--network mainnet \
--rpc-url https://rpc.lightsail.network/ \
--network-passphrase "Public Global Stellar Network ; September 2015"
```

Then go to /admin and withdraw using the ADMIN_AUTH_TOKEN in ./backend/.env

## Configuration Architecture

The backend uses a **shared configuration file** to eliminate duplicate settings:

### Network Switching

Switch between testnet and mainnet by editing `../shared/config/network.js`:
```javascript
export const ACTIVE_NETWORK = 'testnet'; // Change to 'mainnet'
```

### Auto-Loaded from Active Network Config:
- **Testnet**: `../shared/config/accounts.testnet.json` (generated by `./deploy_testnet.sh`)
- **Mainnet**: `../shared/config/accounts.mainnet.json` (generated by `./deploy.sh`)

The config file contains:
- Network (TESTNET/MAINNET/etc)
- RPC URL
- USDC contract ID
- Admin public key
- All 4 smart account contract IDs (A, B, C, D)

### Required in `.env` (secrets only):
- `ADMIN_SECRET_KEY` - Admin account secret key
- `ADMIN_AUTH_TOKEN` - API authentication token
- `SOROSWAP_API_KEY` - Soroswap API key for executing forex swaps

### Optional Overrides (in `.env`):
- `PORT` - Server port (default: 4000)
- `SOROBAN_RPC_URL` - Override RPC endpoint
- `USDC_CONTRACT_ID` - Override USDC contract
- `EURC_CONTRACT_ID` - Override EURC contract for forex swaps
- `ADMIN_PUBLIC_KEY` - Override admin public key
- `EXPLORER_BASE_URL` - Override block explorer URL
- `SOROSWAP_API_BASE_URL` / `SOROSWAP_PROTOCOLS` - Customize Soroswap API routing
- `FOREX_USDC_ACCOUNT_LABEL` / `FOREX_EURC_ACCOUNT_LABEL` - Pick which smart accounts fuel the forex demo

This design ensures:
✅ Single source of truth for deployment config
✅ Secrets stay in `.env` (never committed)
✅ No duplicate configuration across files
✅ Easy to redeploy contracts without updating multiple files

## API Endpoints

### Public Endpoints

**GET /api/balances**
- Returns USDC balances for all 4 accounts

**POST /api/transfer**
- Transfer USDC between accounts A-D
- Body: `{ from: "A", to: "B", amount: "10.5" }`

**GET /api/forex/balances**
- Returns the latest balances for the forex demo (New York USDC, London EURC)

**POST /api/forex/quote**
- Fetches a Soroswap quote for USDC⇄EURC swaps
- Body: `{ direction: "USDC_TO_EURC", amount: "100" }`

**POST /api/forex/swap**
- Builds, signs, and submits the Soroswap transaction once a quote is confirmed
- Body: `{ quote: <raw quote object returned from /api/forex/quote> }`
- Funds never leave the smart accounts. This endpoint calls each account's `execute_forex_transfer` method, which in turn invokes the Soroswap router from within the contract.

### Admin Endpoints (require `X-Auth-Token` header)

**POST /api/admin/withdraw**
- Withdraw USDC from any account to admin address
- Body: `{ account: "A", amount: "5.0" }`
- Requires header: `X-Auth-Token: <ADMIN_AUTH_TOKEN>`

## Key Modules

- **`src/config.ts`** - Loads configuration from shared file + environment
- **`src/lib/soroban.ts`** - All Stellar/Soroban transaction logic
- **`src/controllers/payments.ts`** - API endpoint handlers
- **`src/index.ts`** - Express server setup

## Troubleshooting

### "Failed to load shared configuration"
- Ensure you've run the correct deployment script from repo root:
  - For testnet: `./deploy_testnet.sh`
  - For mainnet: `./deploy.sh`
- Check that `../shared/config/accounts.testnet.json` (or `accounts.mainnet.json`) exists
- Verify `../shared/config/network.js` has the correct `ACTIVE_NETWORK` setting

### "Required environment variable ADMIN_SECRET_KEY is missing"
- Create a `.env` file based on `.env.example`
- Set both `ADMIN_SECRET_KEY` and `ADMIN_AUTH_TOKEN`

### Transaction failures
- Ensure admin account has XLM for fees
- Ensure smart accounts have USDC balance
- Check destination is in the allowed whitelist
