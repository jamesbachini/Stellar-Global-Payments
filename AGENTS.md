# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Stellar blockchain remittance demo showcasing smart accounts built with OpenZeppelin's Stellar contracts framework. The system consists of 4 smart accounts (A, B, C, D) that can transfer USDC only among themselves, with an admin-only withdrawal mechanism. It's designed as an embeddable product demo showing cross-border payments on a world map.

## Architecture

### Smart Contracts (`contracts/`)
- **Language**: Rust with Soroban SDK v23.1.0
- **Framework**: OpenZeppelin Stellar contracts v0.5.0 (`stellar-accounts` package)
- **Contract**: `RemittanceAccount` implements both `SmartAccount` trait and `CustomAccountInterface`:
  - **SmartAccount trait**: Provides full context rule management (add/remove signers, policies, context rules)
  - **CustomAccountInterface**: Implements `__check_auth` using OZ's `do_check_auth` for authorization matching
- **Authorization Pattern**:
  - During `init()`, creates a default context rule with admin as a `Delegated` signer
  - Admin can authorize all operations on the smart account
  - Framework's `do_check_auth()` handles authorization matching against context rules
  - Destination restrictions enforced at application level in `execute_transfer()`
- **Key functions**:
  - `init(admin, token, destinations, label)`: Initialize smart account and create default context rule with admin signer
  - `execute_transfer(to, amount)`: Transfer USDC to whitelisted destination (validates destination before calling token.transfer)
  - `admin_withdraw(amount)`: Admin-only withdrawal to admin address
  - `update_destinations(destinations)`: Update the allowed destination whitelist
  - `get_label()`: Get the account's human-readable label
  - Plus full SmartAccount trait methods: `add_context_rule`, `get_context_rule`, `add_signer`, `add_policy`, etc.

### Backend (`backend/`)
- **Stack**: Node.js + TypeScript + Express
- **Role**: Acts as a hot wallet/relayer to submit transactions on behalf of smart accounts
- **Key module**: `lib/soroban.ts` handles all Stellar/Soroban interactions:
  - `fetchBalances()`: Queries USDC balance for all 4 accounts via rpc simulated tx
  - `submitTransfer()`: Builds and submits `execute_transfer` transaction
  - `submitAdminWithdraw()`: Builds and submits `admin_withdraw` transaction
  - Amount conversion: Handles 7-decimal USDC conversion between string and i128
- **API Endpoints**:
  - `POST /api/transfer`: Transfer between accounts A-D
  - `POST /api/admin/withdraw`: Admin withdrawal (requires auth token)
- **Configuration**: All settings via environment variables (see `.env.example`)

### Frontend (`frontend/`)
- **Stack**: React 18 + TypeScript + Vite
- **UI**: World map with 4 account markers (NY, Paris, Sao Paulo, Singapore)
- **Key components**:
  - `App.tsx`: Main map view orchestrating account markers and transfer modal
  - `AccountMarker.tsx`: Clickable markers showing account label, region, and balance
  - `TransferModal.tsx`: Transfer form with from/to/amount and transaction status
  - `hooks/useAccounts.ts`: Balance fetching and refresh logic
- **Routing**: React Router with `/` for main map and `/admin` for admin console
- **Proxy**: Dev server proxies `/api/*` to backend (localhost:4000)

### Shared Configuration
- `shared/config/accounts.local.json`: Generated by deployment script, contains:
  - Network configuration (TESTNET/MAINNET)
  - RPC URL
  - USDC contract ID
  - Admin public key
  - All 4 smart account contract IDs (A, B, C, D)
- Backend automatically loads this file at startup, eliminating duplicate configuration
- Only secrets (ADMIN_SECRET_KEY, ADMIN_AUTH_TOKEN) are required in `.env`

## Common Commands

### Contracts
```bash
# Build the smart contract
cd contracts
stellar contract build
# Output: contracts/target/wasm32v1-none/release/remittance_accounts.wasm

# Clean build artifacts
cargo clean

# Deploy all 4 smart accounts (requires stellar CLI and funded identity)
cd /mnt/c/code/Stellar-Global-Payments
./deploy.sh
# This deploys 4 instances, initializes them, and writes shared/config/accounts.local.json
```

### Backend
```bash
cd backend

# Install dependencies
npm install

# Development (auto-restart on changes)
npm run dev

# Build TypeScript
npm run build

# Run production build
npm start
```

**Important**: Before running backend, copy `.env.example` to `.env` and configure only these **required secrets**:
- `ADMIN_SECRET_KEY`: Secret key for the relayer/admin account (same account used in deploy.sh)
- `ADMIN_AUTH_TOKEN`: Secret token for admin withdrawal endpoint (generate with `openssl rand -hex 32`)

All other configuration (network, RPC URL, contract IDs) is automatically loaded from `shared/config/accounts.local.json`.

### Frontend
```bash
cd frontend

# Install dependencies
npm install

# Development server (http://localhost:5173)
npm run dev

# Production build
npm run build

# Preview production build
npm run preview
```

## Deployment Flow

1. **Setup Stellar CLI**: Ensure `stellar` CLI is installed and configured
2. **Configure identity**: `stellar keys generate james --network mainnet` (or use existing)
3. **Fund admin account**: Purchase XLM from an exchange or use an existing funded account
4. **Deploy contracts**: Run `./deploy.sh` from repo root
   - Builds WASM binary
   - Deploys 4 smart account instances
   - Initializes each with allowed destinations
   - **Outputs all config to `shared/config/accounts.local.json`**
5. **Configure backend secrets**: Create `backend/.env` with only 2 required values:
   - `ADMIN_SECRET_KEY`: Your admin account secret key (from step 2)
   - `ADMIN_AUTH_TOKEN`: Random secure token (generate with `openssl rand -hex 32`)
   - All other config is auto-loaded from `shared/config/accounts.local.json`
6. **Fund smart accounts**: Send USDC mainnet tokens to the 4 smart account contract addresses
7. **Start services**: Run backend (`npm run dev`) then frontend (`npm run dev`)

## Key Technical Details

### Smart Account Authorization Pattern
The contract uses OpenZeppelin's smart account framework for flexible, programmable authorization:

**Context Rules**: During initialization, a default context rule is created with the admin as a `Delegated` signer. This allows the admin to authorize any operation on the smart account.

**Authorization Flow**:
1. Backend submits transaction calling `execute_transfer` or `admin_withdraw`
2. Smart account's `__check_auth` is invoked by Soroban runtime
3. Calls OZ's `do_check_auth()` which matches signatures against context rules
4. If admin signer is authenticated, authorization succeeds
5. Application logic then validates destination whitelist before executing token transfer

**Key Advantages**:
- Authorization logic is composable (can add policies, multiple signers, etc.)
- Context rules can be updated post-deployment without contract upgrades
- Supports diverse signer types (Delegated accounts, External verifiers for passkeys/zk-proofs)
- Protocol 23 optimizations make cross-contract auth checks efficient

**Destination Restrictions**: While the OZ framework handles *who* can authorize operations, destination whitelist validation is enforced at the application level in `execute_transfer()` before calling the token contract.

### USDC Amount Handling
USDC uses 7 decimals on Stellar. The backend converts:
- User input "1.5" → i128: 15000000 (via `toI128()`)
- Contract i128: 15000000 → "1.5" (via `fromI128()`)

### Transaction Submission
The backend:
1. Builds a transaction calling the smart account contract method
2. Prepares it via `rpc.prepareTransaction()` (simulates and adds footprint)
3. Signs with admin keypair
4. Submits via `rpc.sendTransaction()`
5. Returns hash and explorer URL to frontend

### Frontend State Management
- `useAccounts` hook polls balances on mount and provides a `refresh()` function
- After successful transfer, modal calls `refresh()` to update displayed balances
- Accounts are hardcoded with positions/metadata in `App.tsx`

## Network Configuration

**Default**: Stellar mainnet (`https://rpc.lightsail.network/`)

To use a different network (e.g., testnet for development):
1. Update `deploy.sh`: Change `NETWORK`, `RPC_URL`, `NETWORK_PASSPHRASE`, and `USDC_CONTRACT_ID`
2. Update backend `.env`: Match `NETWORK` and `SOROBAN_RPC_URL` if needed
3. Redeploy contracts with new network settings

**Note**: A testnet deployment script is available as `deploy_testnet.sh` for development/testing purposes.

## Important Files

- `contracts/src/lib.rs`: Smart account contract implementation
- `backend/src/lib/soroban.ts`: All Stellar transaction logic
- `backend/src/config.ts`: Environment variable parsing and types
- `frontend/src/App.tsx`: Main UI orchestration
- `deploy.sh`: Automated deployment script for all 4 accounts
- `backend/.env.example`: Required environment variables
